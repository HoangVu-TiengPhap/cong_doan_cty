<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá th·ªëng B·∫ßu c·ª≠ C√¥ng ƒëo√†n V√≤ng 2</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
      }
      #employee-list, #runoff-candidate-list {
        list-style: none;
        padding: 0;
      }
      #employee-list li, #runoff-candidate-list li {
        background: #fff;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: background 0.2s;
      }
      #employee-list li:hover, #runoff-candidate-list li:hover {
        background: #eef;
      }
      #login-section,
      #voting-section,
      #results-section,
      #runoff-section { /* ƒê√£ th√™m #runoff-section */
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      #top-five-list li {
        margin-bottom: 10px;
        font-size: 1.1em;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-firestore.js"></script>
  </head>
  <body>
    <div id="login-section">
      <h2>ƒêƒÉng nh·∫≠p ƒë·ªÉ B·∫ßu ch·ªçn (V√≤ng 1)</h2>
      <label for="voter-id">ID Nh√¢n vi√™n c·ªßa b·∫°n:</label>
      <input type="text" id="voter-id" placeholder="Nh·∫≠p ID (V√≠ d·ª•: 0001)" />
      <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
      <p id="login-status" style="color: red"></p>
    </div>

    <div id="voting-section" style="display: none">
      <h1>B·∫ßu ch·ªçn Ban Ch·∫•p h√†nh C√¥ng ƒëo√†n (V√≤ng 1: Ch·ªçn t·ªëi ƒëa 5 ng∆∞·ªùi)</h1>
      <form id="vote-form" onsubmit="submitVotes(event)">
        <ul id="employee-list"></ul>
        <p id="selection-count">ƒê√£ ch·ªçn: 0/5</p>
        <button type="submit" disabled id="submit-button">G·ª≠i Phi·∫øu B·∫ßu</button>
      </form>
    </div>

    <hr />
    
    <div id="runoff-section" style="display: none;">
        <h2>V√≤ng 2: B·∫ßu ch·ªçn Ch·ªß t·ªãch C√¥ng ƒëo√†n (Ch·ªçn 1 ng∆∞·ªùi)</h2>
        <p id="runoff-status">ƒêang ch·ªù k·∫øt qu·∫£ V√≤ng 1 ƒë·ªÉ x√°c ƒë·ªãnh ·ª©ng vi√™n...</p>
        <form id="runoff-form" onsubmit="submitRunoffVote(event)">
            <ul id="runoff-candidate-list">
                </ul>
            <button type="submit" disabled id="runoff-submit-button">G·ª≠i Phi·∫øu B·∫ßu Ch·ªß t·ªãch</button>
        </form>
    </div>

    <hr />

    <div id="results-section">
      <h2>K·∫øt qu·∫£ B·∫ßu c·ª≠ (5 ·ª®ng vi√™n D·∫´n ƒë·∫ßu V√≤ng 1)</h2>
      <ol id="top-five-list"></ol>
      <div id="chairman-result-display"></div> <p>K·∫øt qu·∫£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t theo th·ªùi gian th·ª±c.</p>
    </div>

    <script>
      // C·∫•u h√¨nh Firebase c·ªßa b·∫°n
      const firebaseConfig = {
        apiKey: "AIzaSyBuDOvyGwVQByN_U9wD9t732MTFVzGrVuI",
        authDomain: "quick-function-473414-s4.firebaseapp.com",
        projectId: "quick-function-473414-s4",
        storageBucket: "quick-function-473414-s4.firebasestorage.app",
        messagingSenderId: "167302920755",
        appId: "1:167302920755:web:92a2a1c84d8e9406060146",
        measurementId: "G-5Q87ECYLGS",
      };

      let db;
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
      } catch (error) {
        console.error("L·ªói kh·ªüi t·∫°o Firebase:", error);
      }

      const employees = [];
      for (let i = 1; i <= 100; i++) {
        const id = String(i).padStart(4, "0");
        employees.push({
          id: id,
          name: `Nh√¢n vi√™n ${i}`,
        });
      }

      const MAX_SELECTIONS = 5;
      let currentVoterId = null;
      let topFiveCandidates = []; // D·ªØ li·ªáu Top 5 cho V√≤ng 2

      // H√ÄM M·ªöI: Ki·ªÉm tra V√≤ng 1 ƒë√£ ho√†n th√†nh ch∆∞a ƒë·ªÉ k√≠ch ho·∫°t V√≤ng 2
      async function checkRoundOneCompletion(topFive) {
          if (!db) return;
          const TOTAL_EMPLOYEES = employees.length; 
          
          try {
              // L·∫•y s·ªë l∆∞·ª£ng ng∆∞·ªùi ƒë√£ b·∫ßu V√≤ng 1 (t·ª©c l√† s·ªë Document trong voters)
              const snapshot = await db.collection("voters").get();
              const votedCount = snapshot.size; 

              if (votedCount >= TOTAL_EMPLOYEES) {
                  // Ch·ªâ k√≠ch ho·∫°t V√≤ng 2 n·∫øu ƒë√£ c√≥ 5 ·ª©ng vi√™n l·ªçt v√†o
                  if (topFive.length >= 5) {
                      topFiveCandidates = topFive; // L∆∞u l·∫°i Top 5
                      activateRunoffRound(); 
                  } else {
                     document.getElementById('runoff-status').textContent = 'V√≤ng 1 ƒë√£ ho√†n th√†nh nh∆∞ng c·∫ßn th√™m phi·∫øu b·∫ßu ƒë·ªÉ x√°c ƒë·ªãnh ƒë·ªß 5 ·ª©ng vi√™n.';
                  }
              }

          } catch(e) {
              console.error("L·ªói ƒë·∫øm s·ªë ng∆∞·ªùi b·∫ßu (voters collection):", e);
          }
      }
      
      // H√ÄM M·ªöI: K√≠ch ho·∫°t m√†n h√¨nh V√≤ng 2
      function activateRunoffRound() {
          const runoffList = document.getElementById('runoff-candidate-list');
          
          // Ki·ªÉm tra xem ng∆∞·ªùi d√πng hi·ªán t·∫°i ƒë√£ b·∫ßu Ch·ªß t·ªãch ch∆∞a
          checkIfVoterCastChairmanVote().then(voted => {
              if (voted) {
                   document.getElementById('runoff-section').innerHTML = '<h2>B·∫°n ƒë√£ ho√†n th√†nh b·∫ßu ch·ªçn Ch·ªß t·ªãch. C·∫£m ∆°n!</h2>';
                   document.getElementById('voting-section').style.display = 'none';
                   document.getElementById('runoff-section').style.display = 'block';
                   return;
              }

              // N·∫øu ch∆∞a b·∫ßu v√† danh s√°ch ƒë√£ c√≥, hi·ªÉn th·ªã form V√≤ng 2
              if (runoffList.children.length === 0 && topFiveCandidates.length >= 5) {
                  topFiveCandidates.forEach(emp => {
                      const li = document.createElement('li');
                      li.innerHTML = `
                          <input type="radio" id="runoff-emp-${emp.id}" name="chairman" value="${emp.id}" required>
                          <label for="runoff-emp-${emp.id}">${emp.name} (${emp.id})</label>
                      `;
                      runoffList.appendChild(li);
                  });

                  document.getElementById('runoff-status').textContent = 'V√≤ng 2 ƒë√£ m·ªü. Vui l√≤ng ch·ªçn 1 Ch·ªß t·ªãch.';
                  document.getElementById('runoff-submit-button').disabled = false;
              }

              // ·∫®n V√≤ng 1 v√† hi·ªán V√≤ng 2
              document.getElementById('voting-section').style.display = 'none';
              document.getElementById('runoff-section').style.display = 'block';
          });
      }
      
      // H√ÄM M·ªöI: Ki·ªÉm tra ng∆∞·ªùi d√πng ƒë√£ b·∫ßu Ch·ªß t·ªãch ch∆∞a (D√πng collection 'chairman_voters')
      async function checkIfVoterCastChairmanVote() {
          if (!currentVoterId) return false;
          try {
              // Ki·ªÉm tra trong collection m·ªõi ƒë·ªÉ tr√°nh nh·∫ßm l·∫´n v·ªõi voters (V√≤ng 1)
              const doc = await db.collection("chairman_voters").doc(currentVoterId).get();
              return doc.exists;
          } catch(e) {
              console.error("L·ªói ki·ªÉm tra voters V√≤ng 2:", e);
              return false;
          }
      }


      // H√ÄM T·∫†O DANH S√ÅCH ·ª®NG VI√äN V√íNG 1 (kh√¥ng ƒë·ªïi)
      function renderEmployeeList() {
        const ul = document.getElementById("employee-list");
        ul.innerHTML = "";

        employees.forEach((emp) => {
          const li = document.createElement("li");
          li.innerHTML = `
                    <input type="checkbox" id="emp-${emp.id}" name="candidate" value="${emp.id}" onchange="checkSelectionLimit()">
                    <label for="emp-${emp.id}">[${emp.id}] - ${emp.name}</label>
                `;
          ul.appendChild(li);
        });
      }

      // H√ÄM LOGIN (kh√¥ng ƒë·ªïi nhi·ªÅu, ch·ªâ g·ªçi checkRoundOneCompletion)
      async function login() {
        const inputId = document.getElementById("voter-id").value.trim();
        const loginStatus = document.getElementById("login-status");

        if (!db) {
          loginStatus.textContent = "L·ªói h·ªá th·ªëng: Kh√¥ng th·ªÉ k·∫øt n·ªëi Database.";
          return;
        }
        
        if (employees.length === 0) {
             loginStatus.textContent = "ƒêang t·∫£i d·ªØ li·ªáu. Vui l√≤ng ƒë·ª£i ho·∫∑c ki·ªÉm tra file CSV.";
             return;
        }

        const employeeExists = employees.some((e) => e.id === inputId);
        if (!employeeExists) {
          loginStatus.textContent = "ID kh√¥ng h·ª£p l·ªá. Vui l√≤ng th·ª≠ l·∫°i.";
          document.getElementById("voting-section").style.display = "none";
          return;
        }

        // --- B·∫ÆT ƒê·∫¶U KI·ªÇM TRA B·∫¶U C·ª¨ V√íNG 1 ---
        currentVoterId = inputId; // ƒê·∫∑t ID ng∆∞·ªùi b·∫ßu hi·ªán t·∫°i
        
        try {
          const voterDoc = await db.collection("voters").doc(inputId).get();
          if (voterDoc.exists) {
            loginStatus.textContent = `B·∫°n (${inputId}) ƒë√£ ho√†n th√†nh vi·ªác b·∫ßu c·ª≠ V√≤ng 1.`;
            loginStatus.style.color = "blue";
            document.getElementById("login-section").style.display = "none";
            // K√≠ch ho·∫°t ki·ªÉm tra V√≤ng 2 ngay l·∫≠p t·ª©c
            checkRoundOneCompletion(topFiveCandidates); 
            return;
          }
        } catch (error) {
          console.error("L·ªñI SECURITY RULES ho·∫∑c K·∫æT N·ªêI:", error);
          loginStatus.textContent = "L·ªói ki·ªÉm tra ID b·∫ßu c·ª≠. Vui l√≤ng ki·ªÉm tra Quy t·∫Øc b·∫£o m·∫≠t (F12).";
          return;
        }

        // ƒêƒÉng nh·∫≠p th√†nh c√¥ng v√† ch∆∞a b·∫ßu V√≤ng 1
        document.getElementById("login-section").style.display = "none";
        document.getElementById("voting-section").style.display = "block";
        loginStatus.textContent = `Ch√†o m·ª´ng, ${inputId}. Vui l√≤ng ch·ªçn 5 ·ª©ng vi√™n.`;
        loginStatus.style.color = "green";
      }
      
      // H√ÄM G·ª¨I PHI·∫æU B·∫¶U V√íNG 1 (kh√¥ng ƒë·ªïi)
      async function submitVotes(event) {
          // ... (Logic c≈©) ...
      }

      // H√ÄM M·ªöI: G·ª≠i Phi·∫øu B·∫ßu Ch·ªß t·ªãch (V√≤ng 2)
      async function submitRunoffVote(event) {
          event.preventDefault();

          if (!currentVoterId || !db) {
              alert("L·ªói: H·ªá th·ªëng ch∆∞a s·∫µn s√†ng!");
              return;
          }

          const selectedChairmanId = document.querySelector('input[name="chairman"]:checked')?.value;

          if (!selectedChairmanId) {
              alert("Vui l√≤ng ch·ªçn 1 ·ª©ng vi√™n Ch·ªß t·ªãch.");
              return;
          }

          const batch = db.batch();

          // 1. G·ª≠i phi·∫øu b·∫ßu t·ªõi Collection 'chairman_votes'
          const chairmanRef = db.collection("chairman_votes").doc(selectedChairmanId);
          batch.set(
              chairmanRef,
              { 
                  votes: firebase.firestore.FieldValue.increment(1),
                  candidateId: selectedChairmanId,
                  // L·∫•y t√™n t·ª´ m·∫£ng topFiveCandidates
                  name: topFiveCandidates.find(e => e.id === selectedChairmanId)?.name 
              }, 
              { merge: true }
          );

          // 2. ƒê√°nh d·∫•u ng∆∞·ªùi d√πng ƒë√£ b·∫ßu Ch·ªß t·ªãch (Collection 'chairman_voters')
          const chairmanVoterRef = db.collection("chairman_voters").doc(currentVoterId);
          batch.set(chairmanVoterRef, { voted: true, timestamp: firebase.firestore.FieldValue.serverTimestamp() });

          try {
              await batch.commit();
              alert(`ƒê√£ g·ª≠i phi·∫øu b·∫ßu cho Ch·ªß t·ªãch: ${selectedChairmanId}.`);
              document.getElementById('runoff-section').innerHTML = '<h2>B·∫°n ƒë√£ ho√†n th√†nh b·∫ßu ch·ªçn Ch·ªß t·ªãch. C·∫£m ∆°n!</h2>';
          } catch (e) {
              console.error("L·ªói khi g·ª≠i phi·∫øu Ch·ªß t·ªãch:", e);
              alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i phi·∫øu. Vui l√≤ng ki·ªÉm tra Rules.");
          }
      }

      // H√ÄM M·ªöI: Hi·ªÉn th·ªã k·∫øt qu·∫£ Ch·ªß t·ªãch
      function setupChairmanResults() {
          if (!db) return;

          db.collection("chairman_votes")
              .orderBy("votes", "desc")
              .limit(1) 
              .onSnapshot((snapshot) => { 
                  const displayArea = document.getElementById('chairman-result-display');
                  if (snapshot.empty) return;

                  const winnerDoc = snapshot.docs[0];
                  const winnerData = winnerDoc.data();
                  
                  if (winnerData.votes > 0) {
                      const chairmanName = winnerData.name || `·ª®ng vi√™n ${winnerData.candidateId}`;
                      const resultHtml = `
                          <div style="background: #e6ffe6; padding: 15px; border: 2px solid #00cc00; margin-top: 20px;">
                              <h3>üéâ CH·ª¶ T·ªäCH C√îNG ƒêO√ÄN ƒê√É ƒê∆Ø·ª¢C B·∫¶U CH·ªåN üéâ</h3>
                              <p style="font-size: 1.5em; font-weight: bold;">
                                  ${chairmanName} (${winnerData.candidateId})
                              </p>
                              <p>T·ªïng s·ªë phi·∫øu b·∫ßu: ${winnerData.votes}</p>
                          </div>
                      `;
                      displayArea.innerHTML = resultHtml; // C·∫≠p nh·∫≠t khu v·ª±c hi·ªÉn th·ªã
                  }
              });
      }


      // H√ÄM C·∫¨P NH·∫¨T K·∫æT QU·∫¢ V√íNG 1 (ƒê√£ th√™m g·ªçi checkRoundOneCompletion)
      function setupRealtimeResults() {
        if (!db) return;

        db.collection("employees")
          .orderBy("votes", "desc")
          .onSnapshot(
            (snapshot) => {
              const topFive = [];
              snapshot.forEach((doc) => {
                const data = doc.data();
                const emp = employees.find((e) => e.id === doc.id);

                topFive.push({
                  id: doc.id,
                  votes: data.votes || 0,
                  name: emp ? emp.name : `·ª®ng vi√™n ${doc.id}`,
                });
              });

              // --- HI·ªÇN TH·ªä K·∫æT QU·∫¢ V√íNG 1 ---
              const ol = document.getElementById("top-five-list");
              ol.innerHTML = "";

              if (
                topFive.length === 0 ||
                topFive.every((emp) => emp.votes === 0)
              ) {
                ol.innerHTML = "<li>Ch∆∞a c√≥ phi·∫øu b·∫ßu n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</li>";
                // Chuy·ªÉn sang V√≤ng 2 ngay n·∫øu V√≤ng 1 ch∆∞a b·∫ßu (t√πy ch·ªçn)
                // checkRoundOneCompletion(topFive); 
                return;
              }

              topFive.slice(0, 5).forEach((emp, index) => { // Ch·ªâ l·∫•y 5 ng∆∞·ªùi
                const li = document.createElement("li");
                li.innerHTML = `
                            <strong>H·∫°ng ${index + 1}:</strong> ${emp.name} (${
                  emp.id
                }) - <span style="color: blue;">${emp.votes} phi·∫øu</span>
                        `;
                ol.appendChild(li);
              });
              
              // --- KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN V√íNG 2 ---
              checkRoundOneCompletion(topFive); 
            },
            (error) => {
              console.error("L·ªói l·∫Øng nghe k·∫øt qu·∫£ V√≤ng 1:", error);
              document.getElementById("top-five-list").innerHTML =
                "<li>L·ªói t·∫£i k·∫øt qu·∫£ b·∫ßu c·ª≠. (Xem Console F12)</li>";
            }
          );
      }

      // H√ÄM T·∫¢I CSV V√Ä KH·ªûI T·∫†O (Kh√¥ng ƒë·ªïi)
      async function loadEmployeesFromCSV() {
        try {
          document.getElementById('login-status').textContent = 'ƒêang t·∫£i danh s√°ch nh√¢n vi√™n...';
          document.getElementById('login-status').style.color = 'orange';

          const response = await fetch('employees.csv');
          
          if (!response.ok) {
              throw new Error(`Kh√¥ng t√¨m th·∫•y file ho·∫∑c l·ªói m·∫°ng: ${response.status}`);
          }

          const csvText = await response.text();
          const lines = csvText.trim().split('\n');
          
          for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (line) {
                  const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                  
                  const id = parts[0] ? parts[0].trim().replace(/"/g, '') : '';
                  const name = parts[1] ? parts[1].trim().replace(/"/g, '') : '';

                  if (id && name) {
                      employees.push({
                          id: id,
                          name: name
                      });
                  }
              }
          }

          if (employees.length > 0) {
            document.getElementById('login-status').textContent = 'Vui l√≤ng ƒêƒÉng nh·∫≠p.';
            document.getElementById('login-status').style.color = 'red';
          } else {
            document.getElementById('login-status').textContent = 'L·ªñI: CSV tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá.';
          }
          
          renderEmployeeList(); 
          setupRealtimeResults();
          setupChairmanResults(); // B·∫Øt ƒë·∫ßu l·∫Øng nghe k·∫øt qu·∫£ Ch·ªß t·ªãch

        } catch (error) {
          console.error("L·ªñI KH√îNG TH·ªÇ T·∫¢I HO·∫∂C PH√ÇN T√çCH CSV:", error);
          document.getElementById('login-status').textContent = 
            "L·ªñI: Kh√¥ng th·ªÉ t·∫£i danh s√°ch. Vui l√≤ng ki·ªÉm tra file 'employees.csv' (F12).";
        }
      }

      // --- KH·ªûI T·∫†O CU·ªêI C√ôNG ---
      loadEmployeesFromCSV();
    </script>
  </body>
</html>